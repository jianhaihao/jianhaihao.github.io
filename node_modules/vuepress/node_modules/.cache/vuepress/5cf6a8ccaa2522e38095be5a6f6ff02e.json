{"remainingRequest":"D:\\Products\\jianhaihao.github.io\\node_modules\\vue-loader\\lib\\index.js??ref--1-1!D:\\Products\\jianhaihao.github.io\\node_modules\\vuepress\\lib\\webpack\\markdownLoader.js??ref--1-2!D:\\Products\\jianhaihao.github.io\\docs\\swoole\\ws_server.md?vue&type=template&id=274c6fb3&","dependencies":[{"path":"D:\\Products\\jianhaihao.github.io\\docs\\swoole\\ws_server.md","mtime":1552405060829},{"path":"D:\\Products\\jianhaihao.github.io\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1552405062612},{"path":"D:\\Products\\jianhaihao.github.io\\node_modules\\vue-loader\\lib\\loaders\\templateLoader.js","mtime":1552405073713},{"path":"D:\\Products\\jianhaihao.github.io\\node_modules\\cache-loader\\dist\\cjs.js","mtime":1552405062612},{"path":"D:\\Products\\jianhaihao.github.io\\node_modules\\vue-loader\\lib\\index.js","mtime":1552405073709},{"path":"D:\\Products\\jianhaihao.github.io\\node_modules\\vuepress\\lib\\webpack\\markdownLoader.js","mtime":1552405074109}],"contextDependencies":[],"result":["\n<div class=\"content\"><h1 id=\"websocket服务\"><a class=\"header-anchor\" href=\"#websocket服务\" aria-hidden=\"true\">#</a> WebSocket服务</h1>\n<h2 id=\"websocket-特点\"><a class=\"header-anchor\" href=\"#websocket-特点\" aria-hidden=\"true\">#</a> WebSocket 特点</h2>\n<ul>\n<li>建立在TCP协议之上</li>\n<li>性能开销小，通信高效</li>\n<li>客户端可以与任意服务器通信</li>\n<li>协议标识符 <code>ws</code>、<code>wss</code></li>\n<li>持久化网络通信协议</li>\n</ul>\n<h2 id=\"服务端\"><a class=\"header-anchor\" href=\"#服务端\" aria-hidden=\"true\">#</a> 服务端</h2>\n<!--beforebegin--><div class=\"language-php extra-class\"><!--afterbegin--><pre v-pre class=\"language-php\"><code>\n<span class=\"token comment\">//创建websocket服务器对象，监听0.0.0.0:8812端口</span>\n<span class=\"token variable\">$ws</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">swoole_websocket_server</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"0.0.0.0\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">8812</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>\n    <span class=\"token single-quoted-string string\">'enable_static_handler'</span> <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token boolean\">true</span><span class=\"token punctuation\">,</span>\n    <span class=\"token single-quoted-string string\">'document_root'</span>         <span class=\"token operator\">=</span><span class=\"token operator\">></span> <span class=\"token single-quoted-string string\">'/home/haojianhai/swoole-study/assets'</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//监听WebSocket连接打开事件</span>\n<span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'open'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">var_dump</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">fd</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">get</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">server</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">fd</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"hello, welcome\\n\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//监听WebSocket消息事件</span>\n<span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'message'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$frame</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"Message: <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$frame</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">data</span><span class=\"token punctuation\">}</span></span>\\n\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$frame</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">fd</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"server: <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$frame</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">data</span><span class=\"token punctuation\">}</span></span>\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">//监听WebSocket连接关闭事件</span>\n<span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token single-quoted-string string\">'close'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"client-<span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">}</span></span> is closed\\n\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<!--beforeend--></div><!--afterend--><h2 id=\"客户端\"><a class=\"header-anchor\" href=\"#客户端\" aria-hidden=\"true\">#</a> 客户端</h2>\n<!--beforebegin--><div class=\"language-bash extra-class\"><!--afterbegin--><pre v-pre class=\"language-bash\"><code>\n<span class=\"token operator\">&lt;</span><span class=\"token operator\">!</span>DOCTYPE html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>html<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>head<span class=\"token operator\">></span>\n\t<span class=\"token operator\">&lt;</span>meta charset<span class=\"token operator\">=</span><span class=\"token string\">\"utf-8\"</span><span class=\"token operator\">></span>\n\t<span class=\"token operator\">&lt;</span>title<span class=\"token operator\">></span>ws_client<span class=\"token operator\">&lt;</span>/title<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/head<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>body<span class=\"token operator\">></span>\n\n\t<span class=\"token operator\">&lt;</span>h1<span class=\"token operator\">></span>ws测试<span class=\"token operator\">&lt;</span>/h1<span class=\"token operator\">></span>\n\n\t<span class=\"token operator\">&lt;</span>script type<span class=\"token operator\">=</span><span class=\"token string\">\"text/javascript\"</span><span class=\"token operator\">></span>\n\t\tvar wsURL <span class=\"token operator\">=</span> <span class=\"token string\">'ws://192.168.31.54:8812'</span><span class=\"token punctuation\">;</span>\n\n\t\tvar websocket <span class=\"token operator\">=</span> new WebSocket<span class=\"token punctuation\">(</span>wsURL<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\t\t// 实例对象的onopen属性\n\t\twebsocket.onopen <span class=\"token operator\">=</span> function<span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t\twebsocket.send<span class=\"token punctuation\">(</span><span class=\"token string\">\"hello-jianhaihao\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t\tconsole.log<span class=\"token punctuation\">(</span><span class=\"token string\">\"connected-swoole-websocket-success\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t// 实例化 onmessage\n\t\twebsocket.onmessage <span class=\"token operator\">=</span> function<span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t\tconsole.log<span class=\"token punctuation\">(</span><span class=\"token string\">\"ws-server-retunrn-data:\"</span> + evt.data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\t\t\n\t\t// onclose\n\t\twebsocket.onclose <span class=\"token operator\">=</span> function<span class=\"token punctuation\">(</span>evt<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t\tconsole.log<span class=\"token punctuation\">(</span><span class=\"token string\">\"close\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t\t// onerror\n\t\twebsocket.onerror <span class=\"token operator\">=</span> function<span class=\"token punctuation\">(</span>evt, e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t\t\tconsole.log<span class=\"token punctuation\">(</span><span class=\"token string\">\"error: \"</span> + evt.data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\t\t<span class=\"token punctuation\">}</span>\n\n\t<span class=\"token operator\">&lt;</span>/script<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/body<span class=\"token operator\">></span>\n<span class=\"token operator\">&lt;</span>/html<span class=\"token operator\">></span>\n\n</code></pre>\n<!--beforeend--></div><!--afterend--><h2 id=\"服务端优化\"><a class=\"header-anchor\" href=\"#服务端优化\" aria-hidden=\"true\">#</a> 服务端优化</h2>\n<!--beforebegin--><div class=\"language-php extra-class\"><!--afterbegin--><pre v-pre class=\"language-php\"><code>\n<span class=\"token comment\">/**\n * Ws 优化 基础类库\n */</span>\n<span class=\"token keyword\">class</span> <span class=\"token class-name\">Ws</span>\n<span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">HOST</span> <span class=\"token operator\">=</span> <span class=\"token double-quoted-string string\">\"0.0.0.0\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> <span class=\"token constant\">PORT</span> <span class=\"token operator\">=</span> <span class=\"token number\">8812</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token variable\">$ws</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">__construct</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">ws</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">swoole_websocket_server</span><span class=\"token punctuation\">(</span>self<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">HOST</span><span class=\"token punctuation\">,</span> self<span class=\"token punctuation\">:</span><span class=\"token punctuation\">:</span><span class=\"token constant\">PORT</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"open\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"onOpen\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"message\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"onMessage\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">on</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"close\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token variable\">$this</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"onClose\"</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n        <span class=\"token variable\">$this</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">start</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 监听ws连接事件\n     * @param  $ws\n     * @param  $request\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onOpen</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$request</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">var_dump</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$request</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">fd</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * 监听ws消息事件\n     * @param  $ws\n     * @param  $frame\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onMessage</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$frame</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"ser-push-message: <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$frame</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">data</span><span class=\"token punctuation\">}</span></span>\\n\"</span><span class=\"token punctuation\">;</span>\n        <span class=\"token variable\">$ws</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$frame</span><span class=\"token operator\">-</span><span class=\"token operator\">></span><span class=\"token property\">fd</span><span class=\"token punctuation\">,</span> <span class=\"token double-quoted-string string\">\"server-push: \"</span> <span class=\"token punctuation\">.</span> <span class=\"token function\">date</span><span class=\"token punctuation\">(</span><span class=\"token double-quoted-string string\">\"Y-m-d H:i:s\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    <span class=\"token comment\">/**\n     * close\n     * @param  $ws\n     * @param  $fd\n     */</span>\n    <span class=\"token keyword\">public</span> <span class=\"token keyword\">function</span> <span class=\"token function\">onClose</span><span class=\"token punctuation\">(</span><span class=\"token variable\">$ws</span><span class=\"token punctuation\">,</span> <span class=\"token variable\">$fd</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">echo</span> <span class=\"token double-quoted-string string\">\"client-colse-id: <span class=\"token interpolation\"><span class=\"token punctuation\">{</span><span class=\"token variable\">$fd</span><span class=\"token punctuation\">}</span></span>\\n\"</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// 实例化类调用</span>\n<span class=\"token variable\">$obj</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Ws</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n</code></pre>\n<!--beforeend--></div><!--afterend--></div>\n",null]}